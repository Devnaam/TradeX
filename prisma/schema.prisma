// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// 1. USERS TABLE
// ============================================
model User {
  id               Int       @id @default(autoincrement())
  name             String    @db.VarChar(100)
  phone            String    @unique @db.VarChar(10)
  password         String    @db.VarChar(255)
  referralCode     String    @unique @map("referral_code") @db.VarChar(8)
  referredById     Int?      @map("referred_by")
  rechargeBalance  Decimal   @default(0) @map("recharge_balance") @db.Decimal(10, 2)
  incomeBalance    Decimal   @default(0) @map("income_balance") @db.Decimal(10, 2)
  totalWithdraw    Decimal   @default(0) @map("total_withdraw") @db.Decimal(10, 2)
  isBlocked        Boolean   @default(false) @map("is_blocked")
  createdAt        DateTime  @default(now()) @map("created_at")

  // Relations
  referredBy       User?     @relation("UserReferrals", fields: [referredById], references: [id])
  referrals        User[]    @relation("UserReferrals")
  
  bankDetails      BankDetail[]
  deposits         Deposit[]
  withdrawals      Withdrawal[]
  userPlans        UserPlan[]
  dailyIncomeLogs  DailyIncomeLog[]
  referralIncomes  ReferralIncome[] @relation("Referrer")
  earnedReferrals  ReferralIncome[] @relation("ReferredUser")

  @@map("users")
}

// ============================================
// 2. BANK DETAILS TABLE
// ============================================
model BankDetail {
  id                Int      @id @default(autoincrement())
  userId            Int      @map("user_id")
  bankName          String?  @map("bank_name") @db.VarChar(100)
  accountHolderName String?  @map("account_holder_name") @db.VarChar(100)
  accountNumber     String?  @map("account_number") @db.VarChar(20)
  ifscCode          String?  @map("ifsc_code") @db.VarChar(11)
  upiId             String?  @map("upi_id") @db.VarChar(100)
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("bank_details")
}

// ============================================
// 3. DEPOSITS TABLE
// ============================================
model Deposit {
  id             Int      @id @default(autoincrement())
  userId         Int      @map("user_id")
  amount         Decimal  @db.Decimal(10, 2)
  utrNumber      String   @map("utr_number") @db.VarChar(50)
  screenshotUrl  String   @map("screenshot_url") @db.VarChar(255)
  status         String   @default("pending") @db.VarChar(20) // pending, approved, rejected
  adminRemark    String?  @map("admin_remark") @db.Text
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  referralIncomes ReferralIncome[]

  @@map("deposits")
}

// ============================================
// 4. WITHDRAWALS TABLE
// ============================================
model Withdrawal {
  id          Int      @id @default(autoincrement())
  userId      Int      @map("user_id")
  amount      Decimal  @db.Decimal(10, 2)
  method      String   @db.VarChar(20) // upi, bank
  status      String   @default("pending") @db.VarChar(20) // pending, approved, rejected
  adminRemark String?  @map("admin_remark") @db.Text
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("withdrawals")
}

// ============================================
// 5. PLANS TABLE (Pre-populated)
// ============================================
model Plan {
  id           Int      @id @default(autoincrement())
  planNumber   Int      @unique @map("plan_number")
  amount       Decimal  @db.Decimal(10, 2)
  dailyIncome  Decimal  @map("daily_income") @db.Decimal(10, 2)
  validityDays Int      @default(95) @map("validity_days")

  // Relations
  userPlans    UserPlan[]

  @@map("plans")
}

// ============================================
// 6. USER PLANS TABLE
// ============================================
model UserPlan {
  id         Int      @id @default(autoincrement())
  userId     Int      @map("user_id")
  planId     Int      @map("plan_id")
  startDate  DateTime @map("start_date") @db.Date
  expiryDate DateTime @map("expiry_date") @db.Date
  status     String   @default("active") @db.VarChar(20) // active, expired, blocked
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan       Plan     @relation(fields: [planId], references: [id])
  dailyIncomeLogs DailyIncomeLog[]

  @@map("user_plans")
}

// ============================================
// 7. DAILY INCOME LOGS TABLE
// ============================================
model DailyIncomeLog {
  id         Int      @id @default(autoincrement())
  userId     Int      @map("user_id")
  userPlanId Int      @map("user_plan_id")
  amount     Decimal  @db.Decimal(10, 2)
  date       DateTime @db.Date
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userPlan   UserPlan @relation(fields: [userPlanId], references: [id], onDelete: Cascade)

  @@map("daily_income_logs")
}

// ============================================
// 8. REFERRAL INCOMES TABLE
// ============================================
model ReferralIncome {
  id             Int      @id @default(autoincrement())
  referrerId     Int      @map("referrer_id")
  referredUserId Int      @map("referred_user_id")
  depositId      Int      @map("deposit_id")
  amount         Decimal  @db.Decimal(10, 2) // 10% of deposit
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  referrer       User     @relation("Referrer", fields: [referrerId], references: [id], onDelete: Cascade)
  referredUser   User     @relation("ReferredUser", fields: [referredUserId], references: [id], onDelete: Cascade)
  deposit        Deposit  @relation(fields: [depositId], references: [id], onDelete: Cascade)

  @@map("referral_incomes")
}

// ============================================
// 9. PAYMENT SETTINGS TABLE (Admin)
// ============================================
model PaymentSetting {
  id         Int      @id @default(autoincrement())
  qrCodeUrl  String   @map("qr_code_url") @db.VarChar(255)
  upiId      String   @map("upi_id") @db.VarChar(100)
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@map("payment_settings")
}
